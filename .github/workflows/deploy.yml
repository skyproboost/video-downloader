# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# GitHub Actions โ Docker Compose Deploy via Tailscale
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# Secrets in GitHub (Settings โ Secrets โ Actions):
#   - TS_OAUTH_CLIENT_ID     โ Tailscale OAuth client ID
#   - TS_OAUTH_SECRET        โ Tailscale OAuth client secret
#   - VDS_HOST               โ Server's Tailscale IP or MagicDNS hostname
#   - VDS_USER               โ SSH user on the server
#   - VDS_SSH_KEY            โ Private SSH key
#   - SITE_URL               โ https://your-domain.com (for Nuxt build)
#
# Tailscale setup:
#   1. Create an OAuth client at https://login.tailscale.com/admin/settings/oauth
#      with "Devices: Write" scope and a tag (e.g. tag:ci)
#   2. Add an ACL rule allowing tag:ci to access your server over SSH (port 22)
#   3. Set VDS_HOST to the server's Tailscale IP (e.g. 100.x.y.z) or
#      MagicDNS name (e.g. my-server)
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: ๐ Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: ๐ Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ๐ Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: ๐ Deploy via SSH over Tailscale
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e

            APP_DIR="/home/debian/video-downloader"

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ DEPLOYMENT STARTED"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            # 1. Clone or update repository
            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "๐ Cloning repository..."
              git clone "$(cd "$APP_DIR" 2>/dev/null && git remote get-url origin || echo 'REPO_URL_MISSING')" "$APP_DIR"
            fi

            cd "$APP_DIR"

            echo "๐ฅ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            echo "   Commit: $(git rev-parse --short HEAD)"

            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            # 2. Build & restart
            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            echo "๐จ Building and starting containers..."
            docker compose up --build -d --remove-orphans

            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            # 3. Cleanup old images
            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            echo "๐งน Pruning old images..."
            docker image prune -f

            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            # 4. Health check
            # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            echo "๐ฅ Health check..."
            sleep 5
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "โ Frontend is UP"
            else
              echo "โ๏ธ Frontend may have issues, check logs"
            fi

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ DEPLOYMENT COMPLETE"
            echo "   Commit: $(git rev-parse --short HEAD)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
